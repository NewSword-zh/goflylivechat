# ^~ 表示：前缀匹配，优先级最高，强制拦截所有 /goflychat/ 开头的请求
location ^~ /goflychat/ {
    # 1. 重写路径：去掉 /goflychat/ 前缀（比如 /goflychat/static/js/xxx.js → /static/js/xxx.js）
    rewrite ^/goflychat/(.*)$ /$1 break;

    # 2. 添加自定义header，告诉后端这是代理访问
    proxy_set_header X-Proxy-Mode "goflychat";

    # 3. 直接转发到目标服务器（无命名 location，避免语法坑）
    proxy_pass http://47.122.20.1:8081;

    # 4. 必要代理参数（适配 GoFly 服务）
    proxy_set_header Host 47.122.20.1:8081;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Referer "";  # 清空 Referer，避免目标服务器拦截

    # 5. WebSocket 必需配置
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # 6. 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 180s;

    # 7. 跨域配置（只在 OPTIONS 请求返回）
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, WEBSOCKET';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Type 'text/plain; charset=utf-8';
        add_header Content-Length 0;
        return 204;
    }
}